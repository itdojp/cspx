# スケール設計（M5）

## DiskStateStore の永続化方式
### 目的
- 大規模モデル向けに、状態集合をディスクへ退避してメモリ消費を抑える。
- CI-first の再現性を損なわないこと（再実行で同じ集合を再構築可能）。

### 方式（v0.1 / 実装準拠）
- **レコード形式**: `StateCodec` によるバイト列を 16進文字列化し、1行1レコードで追記（append-only）。
- **同一判定**: 16進文字列の完全一致（`codec.encode(state)` の結果が一致することが前提）。
- **インデックス**: 起動時に全行を読み込み、インメモリ `HashSet` を構築（現在の実装）。

### 衝突回避方針
- **要件**: `StateCodec` は **同一状態に対して同一バイト列** を返す決定的実装であること。
- **衝突回避**: 仕様上は「同一バイト列=同一状態」とみなすため、  
  事実上「エンコード衝突が起きない設計」を要求する（必要なら `codec` 内で完全シリアライズ）。
- **将来拡張案**:
  - `codec` をバージョン付きにし、`state_version` をヘッダに持つ。
  - `codec` のみ差し替えても既存ログが読めるよう `migration` 手順を明示。

### インデックスの外部化（将来）
- **外部インデックス**: `state.log`（追記）と `state.idx`（ソート済み or 構造化）を分離。
- **再構築**: 起動時に `state.idx` が存在しない場合は `state.log` を再スキャンして生成。
- **コンパクション**: 一定サイズで `state.log` を圧縮/再生成（重複除外済みのログを作成）。

### 永続化の安全性
今後の要件（v0.2以降）として明文化する項目:
- 書き込みの原子性（`fsync` の要否、クラッシュ時の復旧手順）
- 排他制御（同一ファイルに対する並列書き込みの禁止/ロック方式）

## explore_parallel の決定性要件
### 目的
- 並列探索の性能を得つつ、CI での再現性を損なわない。

### 現状の位置づけ（v0.1 / 最小実装）
- `explore_parallel` は **探索順序の決定性を保証しない**。
- ただし、`TransitionProvider` が決定的であり、探索対象が有限である限り、  
  **到達状態集合と統計値（states/transitions）は一致**することを目標とする。

### 決定性を要求する場合の方針（今後）
以下を満たす「deterministic mode」を追加要件とする:
- **固定ワーカー数** と **固定シード**（`--seed`）を要求
- **遷移の順序規約**（例: `label` を辞書順にソート）
- **バッチング規約**（frontier を固定順に分割し、ワーカーへ割当）
- **結果の再現性**: 同一入力/同一seed/同一worker数で同一結果（少なくとも単一環境）

### CLI への反映（将来）
- `--parallel <n>` で並列探索を有効化
- `--deterministic` で探索順序規約を強制
- `--seed` は deterministic モードで必須
