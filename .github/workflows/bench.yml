name: Bench

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      update_baseline_candidate:
        description: "Generate baseline candidate JSON artifact from current run"
        required: false
        type: boolean
        default: false

concurrency:
  group: bench-${{ github.ref }}
  cancel-in-progress: false

jobs:
  bench:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    env:
      BENCH_BASELINE_FILE: benchmarks/baseline/bench-metrics-baseline.json
      BENCH_WARN_THRESHOLD_PCT: "20"
      BENCH_FAIL_THRESHOLD_PCT: "40"
      BENCH_MIN_BASELINE_MS: "100"
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build cspx release
        run: cargo build -p cspx --release
      - name: Run bench suite
        id: bench
        run: |
          set -euo pipefail
          mkdir -p artifacts/bench
          mkdir -p problems/.out
          set +e
          scripts/run-problems \
            --suite bench \
            --measure-runs 5 \
            --warmup-runs 1 \
            --cspx target/release/cspx | tee artifacts/bench/run.log
          rc=$?
          set -e

          echo "${rc}" > artifacts/bench/exit_code.txt
          echo "exit_code=${rc}" >> "$GITHUB_OUTPUT"

          total=0
          pass=0
          fail=0
          while IFS= read -r report; do
            total=$((total + 1))
            if grep -q '^PASS' "$report"; then
              pass=$((pass + 1))
            else
              fail=$((fail + 1))
            fi
          done < <(find problems/.out -mindepth 2 -maxdepth 2 -name report.txt | sort)

          metrics_count=$(find problems/.out -name metrics-summary.json | wc -l | tr -d ' ')

          {
            echo "## Bench Summary"
            echo "- run_exit_code: ${rc}"
            echo "- total_problems: ${total}"
            echo "- pass: ${pass}"
            echo "- fail: ${fail}"
            echo "- metrics_summary_files: ${metrics_count}"
            echo "- policy: bench suite measure-runs=5 warmup-runs=1"
          } >> "$GITHUB_STEP_SUMMARY"

          if [ "${rc}" -eq 2 ]; then
            echo "cspx-problems runner internal error" >&2
            exit 2
          fi

          if [ "${rc}" -ne 0 ] && [ "${rc}" -ne 1 ]; then
            echo "Unexpected non-zero exit code from scripts/run-problems: ${rc}" >&2
            exit "${rc}"
          fi
      - name: Compare bench baseline
        id: baseline
        run: |
          set -euo pipefail
          mkdir -p artifacts/bench
          set +e
          scripts/bench-baseline compare \
            --out-dir problems/.out \
            --baseline "${BENCH_BASELINE_FILE}" \
            --report-json artifacts/bench/baseline-compare.json \
            --report-md artifacts/bench/baseline-compare.md \
            --warn-threshold-pct "${BENCH_WARN_THRESHOLD_PCT}" \
            --fail-threshold-pct "${BENCH_FAIL_THRESHOLD_PCT}" \
            --min-baseline-ms "${BENCH_MIN_BASELINE_MS}"
          rc=$?
          set -e
          echo "compare_exit_code=${rc}" >> "$GITHUB_OUTPUT"
          if [ -f artifacts/bench/baseline-compare.md ]; then
            cat artifacts/bench/baseline-compare.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "baseline compare report is unavailable" >> "$GITHUB_STEP_SUMMARY"
          fi
          if [ "${rc}" -ne 0 ]; then
            echo "bench baseline comparison failed" >&2
            exit "${rc}"
          fi
      - name: Write baseline candidate artifact
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.update_baseline_candidate }}
        run: |
          set -euo pipefail
          scripts/bench-baseline write \
            --out-dir problems/.out \
            --baseline artifacts/bench/bench-metrics-baseline.candidate.json \
            --warn-threshold-pct "${BENCH_WARN_THRESHOLD_PCT}" \
            --fail-threshold-pct "${BENCH_FAIL_THRESHOLD_PCT}" \
            --min-baseline-ms "${BENCH_MIN_BASELINE_MS}"
          {
            echo ""
            echo "### Baseline Candidate"
            echo "- artifact: artifacts/bench/bench-metrics-baseline.candidate.json"
            echo "- apply: replace benchmarks/baseline/bench-metrics-baseline.json in a PR"
          } >> "$GITHUB_STEP_SUMMARY"
      - name: Upload bench artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bench-results
          path: |
            artifacts/bench
            problems/.out
          if-no-files-found: warn
