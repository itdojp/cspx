name: Bench

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

concurrency:
  group: bench-${{ github.ref }}
  cancel-in-progress: false

jobs:
  bench:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build cspx release
        run: cargo build -p cspx --release
      - name: Run bench suite
        id: bench
        run: |
          set -euo pipefail
          mkdir -p artifacts/bench
          set +e
          scripts/run-problems --suite bench --cspx target/release/cspx | tee artifacts/bench/run.log
          rc=$?
          set -e

          echo "${rc}" > artifacts/bench/exit_code.txt
          echo "exit_code=${rc}" >> "$GITHUB_OUTPUT"

          total=0
          pass=0
          fail=0
          while IFS= read -r report; do
            total=$((total + 1))
            if grep -q '^PASS' "$report"; then
              pass=$((pass + 1))
            else
              fail=$((fail + 1))
            fi
          done < <(find problems/.out -mindepth 2 -maxdepth 2 -name report.txt | sort)

          metrics_count=$(find problems/.out -name metrics-summary.json | wc -l | tr -d ' ')

          {
            echo "## Bench Summary"
            echo "- run_exit_code: ${rc}"
            echo "- total_problems: ${total}"
            echo "- pass: ${pass}"
            echo "- fail: ${fail}"
            echo "- metrics_summary_files: ${metrics_count}"
            echo "- policy: bench suite default run"
          } >> "$GITHUB_STEP_SUMMARY"

          if [ "${rc}" -eq 2 ]; then
            echo "cspx-problems runner internal error" >&2
            exit 2
          fi
      - name: Upload bench artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bench-results
          path: |
            artifacts/bench
            problems/.out
          if-no-files-found: warn
